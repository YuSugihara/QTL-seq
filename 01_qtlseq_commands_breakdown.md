# QTL-seq Commands Breakdown

This document provides a comprehensive overview of the commands used in the QTL-seq pipeline. By understanding each step's purpose, usage, and the default parameters employed in QTL-seq, users may be able to run the bash commands independently to troubleshoot and resolve issues more effectively. The goal is to help users better understand the internal workings of QTL-seq and ensure efficient execution.

## Table of Contents

1. [Using the Test Dataset](#using-the-test-dataset)
2. [Step 1: Directory Setup](#step-1-directory-setup)
3. [Step 2: Quality Control and Trimming](#step-2-quality-control-and-trimming)
4. [Step 3: Reference Genome Indexing](#step-3-reference-genome-indexing)
5. [Step 4: Read Alignment and BAM Processing](#step-4-read-alignment-and-bam-processing)
6. [Step 5: BAM Sorting and Indexing](#step-5-bam-sorting-and-indexing)
7. [Step 6: Variant Calling with mpileup](#step-6-variant-calling-with-mpileup)
8. [Step 7: SNP Filtering, SNP Index Calculation, and Visualization with QTL-plot](#step-7-snp-filtering-snp-index-calculation-and-visualization-with-qtl-plot)

---

## Using the Test Dataset

To get started with QTL-seq and verify the pipeline's functionality, you can use the test dataset available in the QTL-seq GitHub repository. The test dataset is located [here](https://github.com/YuSugihara/QTL-seq/tree/master/test), and it includes all the necessary files to run the pipeline:

- **adapter.fasta**: Adapter sequences for trimming.
- **bulk1_SNPindex.png**, **bulk2_SNPindex.png**, **delta_SNPindex.png**: Output images from QTL-plot.
- **qtlseq.sh**: Shell script to run the QTL-seq pipeline.
- **FASTQ files**: Paired-end reads for parent, bulk1, and bulk2.

By using this test dataset, you can execute the commands in this document step by step to ensure that the pipeline runs smoothly and correctly.

---

## Step 1: Directory Setup

Before starting the pipeline, ensure that all necessary directories are created. This prevents errors from occurring when output directories are missing. The following structure should be in place:

```bash
mkdir -p output_directory/00_fastq
mkdir -p output_directory/10_ref
mkdir -p output_directory/20_bam
mkdir -p output_directory/30_vcf
```

- **00_fastq**: For storing filtered FASTQ files.
- **10_ref**: For storing reference genome index files.
- **20_bam**: For storing BAM files after alignment.
- **30_vcf**: For storing the VCF files generated by variant calling.

---

## Step 2: Quality Control and Trimming

**Description**:  
Trimming is the process of removing low-quality sequences and adapters from raw sequencing data. This step is essential to ensure that the data used for alignment is clean and of high quality. In QTL-seq, trimming is performed using **Trimmomatic** on the **parent**, **bulk1**, and **bulk2** in the same manner.

**Usage**:

```bash
trimmomatic PE -threads 4 \
               -phred33 qtlseq_parent.1.fastq.gz qtlseq_parent.2.fastq.gz \
               output_directory/00_fastq/parent_R1_paired.fastq.gz \
               output_directory/00_fastq/parent_R1_unpaired.fastq.gz \
               output_directory/00_fastq/parent_R2_paired.fastq.gz \
               output_directory/00_fastq/parent_R2_unpaired.fastq.gz \
               ILLUMINACLIP:adapter.fasta:2:30:10 \
               LEADING:20 \
               TRAILING:20 \
               SLIDINGWINDOW:4:15 \
               MINLEN:75

trimmomatic PE -threads 4 \
               -phred33 qtlseq_bulk1.1.fastq.gz qtlseq_bulk1.2.fastq.gz \
               output_directory/00_fastq/bulk1_R1_paired.fastq.gz \
               output_directory/00_fastq/bulk1_R1_unpaired.fastq.gz \
               output_directory/00_fastq/bulk1_R2_paired.fastq.gz \
               output_directory/00_fastq/bulk1_R2_unpaired.fastq.gz \
               ILLUMINACLIP:adapter.fasta:2:30:10 \
               LEADING:20 \
               TRAILING:20 \
               SLIDINGWINDOW:4:15 \
               MINLEN:75

trimmomatic PE -threads 4 \
               -phred33 qtlseq_bulk2.1.fastq.gz qtlseq_bulk2.2.fastq.gz \
               output_directory/00_fastq/bulk2_R1_paired.fastq.gz \
               output_directory/00_fastq/bulk2_R1_unpaired.fastq.gz \
               output_directory/00_fastq/bulk2_R2_paired.fastq.gz \
               output_directory/00_fastq/bulk2_R2_unpaired.fastq.gz \
               ILLUMINACLIP:adapter.fasta:2:30:10 \
               LEADING:20 \
               TRAILING:20 \
               SLIDINGWINDOW:4:15 \
               MINLEN:75
```

**Explanation**:

- `PE`: Specifies paired-end mode.
- `ILLUMINACLIP`: Trims adapter sequences based on the adapter file provided.
- `LEADING`: Trims low-quality bases from the beginning of the read.
- `TRAILING`: Trims low-quality bases from the end of the read.
- `SLIDINGWINDOW`: Performs sliding window trimming, trimming when the average quality within the window falls below a threshold.
- `MINLEN`: Discards reads that are shorter than the specified length.

---

## Step 3: Reference Genome Indexing

**Description**:  
Before aligning reads to the reference genome, the genome must be indexed. Indexing creates necessary data structures that make the alignment process more efficient. In QTL-seq, **BWA** and **SAMtools** are used for reference genome indexing.

For more information, please refer to the **BWA** manual [here](http://bio-bwa.sourceforge.net/bwa.shtml) and the **SAMtools** manual [here](https://www.htslib.org/doc/samtools.html).

**Reference Genome Indexing**:

```bash
# Create a symbolic link to reference genome in 10_ref
ln -s $(pwd)/qtlseq_ref.fasta output_directory/10_ref/qtlseq_ref.fasta

# Index the reference genome using BWA
bwa index output_directory/10_ref/qtlseq_ref.fasta

# Index the reference genome using SAMtools
samtools faidx output_directory/10_ref/qtlseq_ref.fasta
```

---

## Step 4: Read Alignment and BAM Processing

**Description**:  
Alignment is performed on the **parent**, **bulk1**, and **bulk2** in the same manner. After trimming and indexing the reference genome, the next step is to align the sequencing reads to the reference using **BWA**, followed by **SAMtools** for processing the SAM/BAM files.

For more information on **BWA**, refer to its manual [here](http://bio-bwa.sourceforge.net/bwa.shtml). Additionally, refer to the **SAMtools** manual [here](https://www.htslib.org/doc/samtools.html).

**Usage**:

```bash
bwa mem -t 4 output_directory/10_ref/qtlseq_ref.fasta \
    output_directory/00_fastq/parent_R1_paired.fastq.gz \
    output_directory/00_fastq/parent_R2_paired.fastq.gz | \
samtools fixmate -m - - | \
samtools sort -m 1G -@ 4 -o output_directory/20_bam/parent.unsorted.bam - | \
samtools markdup -r - - | \
samtools view -b -f 2 -F 2048 -o output_directory/20_bam/parent.bam

bwa mem -t 4 output_directory/10_ref/qtlseq_ref.fasta \
    output_directory/00_fastq/bulk1_R1_paired.fastq.gz \
    output_directory/00_fastq/bulk1_R2_paired.fastq.gz | \
samtools fixmate -m - - | \
samtools sort -m 1G -@ 4 -o output_directory/20_bam/bulk1.unsorted.bam - | \
samtools markdup -r - - | \
samtools view -b -f 2 -F 2048 -o output_directory/20_bam/bulk1.bam

bwa mem -t 4 output_directory/10_ref/qtlseq_ref.fasta \
    output_directory/00_fastq/bulk2_R1_paired.fastq.gz \
    output_directory/00_fastq/bulk2_R2_paired.fastq.gz | \
samtools fixmate -m - - | \
samtools sort -m 1G -@ 4 -o output_directory/20_bam/bulk2.unsorted.bam - | \
samtools markdup -r - - | \
samtools view -b -f 2 -F 204

8 -o output_directory/20_bam/bulk2.bam
```

**Explanation**:

- `mem`: The algorithm used by BWA to align paired-end reads.
- `-t 4`: Specifies the number of threads to use (in this case, 4 threads).
- `fixmate -m`: Adjusts mate-pair information in the BAM file for consistency and adds the `ms` (mate score) tag, which is used by `markdup` to select the best reads to keep during duplicate marking.
- `sort`: Sorts the BAM file by genomic coordinates.
- `markdup`: Removes PCR duplicates to avoid bias in variant calling.
- `view`: Converts the data into BAM format.
- `-b`: Outputs the data in BAM format.
- `-f 2`: Selects properly paired reads.
- `-F 2048`: Excludes supplementary alignments (e.g., secondary mappings).

---

## Step 5: BAM Sorting and Indexing

**Description**:  
Sorting and indexing are performed on the **parent**, **bulk1**, and **bulk2** in the same manner. After aligning the reads, **SAMtools** is used to sort and index the resulting BAM files for efficient access and analysis. Sorting ensures that the reads are ordered by their position in the genome, and indexing creates a .bai file that allows for fast retrieval of specific regions during analysis.

**Usage**:

```bash
samtools sort -m 1G -@ 4 -o output_directory/20_bam/parent.bam output_directory/20_bam/parent.unsorted.bam
samtools index output_directory/20_bam/parent.bam

samtools sort -m 1G -@ 4 -o output_directory/20_bam/bulk1.bam output_directory/20_bam/bulk1.unsorted.bam
samtools index output_directory/20_bam/bulk1.bam

samtools sort -m 1G -@ 4 -o output_directory/20_bam/bulk2.bam output_directory/20_bam/bulk2.unsorted.bam
samtools index output_directory/20_bam/bulk2.bam
```

**Explanation**:

- `sort`: Sorts the BAM file by genomic coordinates.
- `-m 1G`: Limits the memory usage to 1 GB per thread.
- `-@ 4`: Uses 4 threads for sorting.
- `index`: Creates an index file (.bai) for the sorted BAM file.

### Note for Large Genomes (e.g., Wheat):

For larger genomes like wheat, using the default `samtools index` may lead to inefficiencies due to the size of the BAM file. In such cases, it is recommended to use the `-c` option:

```bash
samtools index -c output_directory/20_bam/parent.bam
samtools index -c output_directory/20_bam/bulk1.bam
samtools index -c output_directory/20_bam/bulk2.bam
```

This creates a CSI index that supports larger reference genomes.

---

## Step 6: Variant Calling with mpileup

**Description**:  
Once the BAM files are indexed, the next step is to call variants using **bcftools mpileup** and **bcftools call**. The `AD`, `ADF`, and `ADR` fields are critical for QTL-seq, as they provide allele depth information that is essential for the analysis. This command identifies SNPs and other variants in the sequencing data.

For more information on **BCFtools**, refer to the manual [here](https://www.htslib.org/doc/bcftools.html).

### Usage:

```bash
bcftools mpileup -a AD,ADF,ADR -B -q 40 -Q 18 -C 50 -O u -f output_directory/10_ref/qtlseq_ref.fasta \
output_directory/20_bam/parent.bam output_directory/20_bam/bulk1.bam output_directory/20_bam/bulk2.bam | \
bcftools call -vm -f GQ,GP -O u | \
bcftools filter -i "INFO/MQ>=40" -O z -o output_directory/30_vcf/qtlseq.vcf.gz
```

**Explanation**:

- `mpileup`: Generates per-base information for each position in the reference genome.
- `-a AD,ADF,ADR`: Includes allele depth information in the output. These fields are crucial for QTL-seq analysis.
- `-B`: Disables BAQ computation.
- `-q 40`: Filters reads with mapping quality less than 40.
- `-Q 18`: Filters bases with base quality less than 18.
- `-C 50`: Adjusts the mapping quality to account for the use of BWA during alignment.

**Note**: When generating the VCF file, the order in which the **parent**, **bulk1**, and **bulk2** BAM files are passed into the `bcftools mpileup` command is important. The **parent** should come first, followed by **bulk1**, and then **bulk2**. This order is critical for downstream analysis, especially when using **QTL-plot**, as the software expects the **parent** data to be the first sample in the VCF file.

---

## Step 7: SNP Filtering, SNP Index Calculation, and Visualization with QTL-plot

**Description**:  
QTL-plot is used to filter SNPs, calculate SNP indices, and visualize the results. It helps identify significant SNPs and their impact on the genome, producing various files that assist in analyzing and visualizing the data.

**Usage**:

```bash
qtlplot -v output_directory/30_vcf/qtlseq.vcf.gz -n1 100 -n2 100 -o output_directory/40_plot
```

**Required Options**:

- `-v`: Specifies the input VCF file generated by the variant calling step.
- `-n1`: Specifies the number of individuals in bulk1.
- `-n2`: Specifies the number of individuals in bulk2.
- `-o`: Specifies the output directory for the visualization results.
