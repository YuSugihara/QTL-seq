# QTL-seq Commands Breakdown

This document provides a comprehensive overview of the commands used in the QTL-seq pipeline. By understanding each step's purpose, usage, and the default parameters employed in QTL-seq, users can independently run the bash commands to troubleshoot and resolve issues more effectively. The goal is to help users better understand the internal workings of QTL-seq and ensure efficient execution.

## Table of Contents

1. [Using the Test Dataset](#using-the-test-dataset)
2. [Step 1: Directory Setup](#step-1-directory-setup)
3. [Step 2: Quality Control and Trimming](#step-2-quality-control-and-trimming)
4. [Step 3: Reference Genome Indexing](#step-3-reference-genome-indexing)
5. [Step 4: Read Alignment](#step-4-read-alignment)
6. [Step 5: BAM Sorting and Indexing](#step-5-bam-sorting-and-indexing)
7. [Step 6: Variant Calling with mpileup](#step-6-variant-calling-with-mpileup)
8. [Step 7: SNP Filtering, SNP Index Calculation, and Visualization with QTLplot](#step-7-snp-filtering-snp-index-calculation-and-visualization-with-qtlplot)
9. [Using SnpEff for Variant Annotation](#using-snpeff-for-variant-annotation)

---

## Using the Test Dataset

To get started with QTL-seq and verify the pipeline's functionality, you can use the test dataset available in the QTL-seq GitHub repository. The test dataset is located [here](https://github.com/YuSugihara/QTL-seq/tree/master/test), and it includes all the necessary files to run the pipeline.

By using this test dataset, you can execute the commands in this document step by step to ensure that the pipeline runs smoothly and correctly.

---

## Step 1: Directory Setup

Before starting the pipeline, ensure that all necessary directories are created. This prevents errors from occurring when output directories are missing. The following structure should be in place:

```bash
mkdir -p output_directory/00_fastq
mkdir -p output_directory/10_ref
mkdir -p output_directory/20_bam
mkdir -p output_directory/30_vcf
```

- **00_fastq**: For storing filtered FASTQ files.
- **10_ref**: For storing reference genome index files.
- **20_bam**: For storing BAM files after alignment.
- **30_vcf**: For storing the VCF files generated by variant calling.

---

## Step 2: Quality Control and Trimming

**Description**:  
Trimming is the process of removing low-quality sequences and adapters from raw sequencing data. This step is essential to ensure that the data used for alignment is clean and of high quality. In QTL-seq, trimming is performed using **Trimmomatic** on the **parent** and **bulk1** and **bulk2** in the same manner.

**Usage**:

```bash
trimmomatic PE -threads 4 \
               -phred33 qtlseq_parent.1.fastq.gz qtlseq_parent.2.fastq.gz \
               output_directory/00_fastq/parent_R1_paired.fastq.gz \
               output_directory/00_fastq/parent_R1_unpaired.fastq.gz \
               output_directory/00_fastq/parent_R2_paired.fastq.gz \
               output_directory/00_fastq/parent_R2_unpaired.fastq.gz \
               ILLUMINACLIP:adapter.fasta:2:30:10 \
               LEADING:20 \
               TRAILING:20 \
               SLIDINGWINDOW:4:15 \
               MINLEN:75

trimmomatic PE -threads 4 \
               -phred33 qtlseq_bulk1.1.fastq.gz qtlseq_bulk1.2.fastq.gz \
               output_directory/00_fastq/bulk1_R1_paired.fastq.gz \
               output_directory/00_fastq/bulk1_R1_unpaired.fastq.gz \
               output_directory/00_fastq/bulk1_R2_paired.fastq.gz \
               output_directory/00_fastq/bulk1_R2_unpaired.fastq.gz \
               ILLUMINACLIP:adapter.fasta:2:30:10 \
               LEADING:20 \
               TRAILING:20 \
               SLIDINGWINDOW:4:15 \
               MINLEN:75

trimmomatic PE -threads 4 \
               -phred33 qtlseq_bulk2.1.fastq.gz qtlseq_bulk2.2.fastq.gz \
               output_directory/00_fastq/bulk2_R1_paired.fastq.gz \
               output_directory/00_fastq/bulk2_R1_unpaired.fastq.gz \
               output_directory/00_fastq/bulk2_R2_paired.fastq.gz \
               output_directory/00_fastq/bulk2_R2_unpaired.fastq.gz \
               ILLUMINACLIP:adapter.fasta:2:30:10 \
               LEADING:20 \
               TRAILING:20 \
               SLIDINGWINDOW:4:15 \
               MINLEN:75
```

**Explanation**:

- `PE`: Specifies paired-end mode.
- `ILLUMINACLIP`: Trims adapter sequences based on the adapter file provided.
- `LEADING`: Trims low-quality bases from the beginning of the read.
- `TRAILING`: Trims low-quality bases from the end of the read.
- `SLIDINGWINDOW`: Performs sliding window trimming, trimming when the average quality within the window falls below a threshold.
- `MINLEN`: Discards reads that are shorter than the specified length.

**Additional Information**:

1. **Trimmomatic GitHub Repository**: For more information on Trimmomatic, refer to its [GitHub repository](https://github.com/usadellab/Trimmomatic).

2. **Adapter Sequences**: The adapter sequences used in the trimming process can be found on the [Trimmomatic GitHub](https://github.com/timflutre/trimmomatic/tree/master/adapters).

3. **Quality Control**: After trimming, it is recommended to perform quality control (QC) on the resulting FASTQ files using software like [FastQC](https://github.com/s-andrews/FastQC).

4. **Alternative Software - fastp**: If you are unsure about which adapter sequences were used, the software [fastp](https://github.com/OpenGene/fastp) may be useful. It includes the `--detect_adapter_for_pe` option, which automatically detects and removes adapter sequences. However, please note that QTL-seq has not been extensively tested with fastp, so its compatibility cannot be guaranteed.

---

## Step 3: Reference Genome Indexing

**Description**:  
Before aligning reads to the reference genome, the genome must be indexed. Indexing creates necessary data structures that make the alignment process more efficient. In QTL-seq, **BWA** and **SAMtools** are used for reference genome indexing.

For more information, please refer to the **BWA** manual [here](http://bio-bwa.sourceforge.net/bwa.shtml) and the **SAMtools** manual [here](https://www.htslib.org/doc/samtools.html).

**Reference Genome Indexing**:

```bash
# Create a symbolic link to reference genome in 10_ref
ln -s $(pwd)/qtlseq_ref.fasta output_directory/10_ref/qtlseq_ref.fasta

# Index the reference genome using BWA
bwa index output_directory/10_ref/qtlseq_ref.fasta

# Index the reference genome using SAMtools
samtools faidx output_directory/10_ref/qtlseq_ref.fasta
```

---

## Step 4: Read Alignment

**Description**:  
Alignment is performed on the **parent**, **bulk1**, and **bulk2** in the same manner. After trimming and indexing the reference genome, the next step is to align the sequencing reads to the reference using **BWA**, followed by **SAMtools** for converting the output to BAM format.

For more information on **BWA**, refer to its manual [here](http://bio-bwa.sourceforge.net/bwa.shtml). Additionally, refer to the **SAMtools** manual [here](https://www.htslib.org/doc/samtools.html).

**Usage**:

```bash
bwa mem -t 4 output_directory/10_ref/qtlseq_ref.fasta \
    output_directory/00_fastq/parent_R1_paired.fastq.gz \
    output_directory/00_fastq/parent_R2_paired.fastq.gz | \
samtools view -b \
              -o output_directory/20_bam/parent.unsorted.bam

bwa mem -t 4 output_directory/10_ref/qtlseq_ref.fasta \
    output_directory/00_fastq/bulk1_R1_paired.fastq.gz \
    output_directory/00_fastq/bulk1_R2_paired.fastq.gz | \
samtools view -b \
              -o output_directory/20_bam/bulk1.unsorted.bam

bwa mem -t 4 output_directory/10_ref/qtlseq_ref.fasta \
    output_directory/00_fastq/bulk2_R1_paired.fastq.gz \
    output_directory/00_fastq/bulk2_R2_paired.fastq.gz | \
samtools view -b \
              -o output_directory/20_bam/bulk2.unsorted.bam
```

**

Explanation**:

- `mem`: The algorithm used by BWA to align paired-end reads.
- `-t 4`: Specifies the number of threads to use (in this case, 4 threads).
- `view -b`: Converts the data into BAM format.
- `-o`: Specifies the output BAM file location.

---

## Step 5: BAM Sorting and Indexing

**Description**:  
Sorting and indexing are performed on the **parent**, **bulk1**, and **bulk2** in the same manner. After aligning the reads, **SAMtools** is used to sort and index the resulting BAM files for efficient access and analysis. Sorting ensures that the reads are ordered by their position in the genome, and indexing creates a `.bai` or `.csi` file that allows for fast retrieval of specific regions during analysis.

**Usage**:

```bash
samtools fixmate -m output_directory/20_bam/parent.unsorted.bam - | \
samtools sort -m 1G -@ 4 | \
samtools markdup -r - - | \
samtools view -b -f 2 -F 2048 -o output_directory/20_bam/parent.bam

samtools fixmate -m output_directory/20_bam/bulk1.unsorted.bam - | \
samtools sort -m 1G -@ 4 | \
samtools markdup -r - - | \
samtools view -b -f 2 -F 2048 -o output_directory/20_bam/bulk1.bam

samtools fixmate -m output_directory/20_bam/bulk2.unsorted.bam - | \
samtools sort -m 1G -@ 4 | \
samtools markdup -r - - | \
samtools view -b -f 2 -F 2048 -o output_directory/20_bam/bulk2.bam
```

**Explanation**:

- `fixmate -m`: Adjusts mate-pair information and adds `ms` (mate score) tags, used by `markdup` to select the best reads for duplicate removal.
- `sort`: Sorts the BAM file by genomic coordinates.
- `markdup`: Removes duplicate reads to avoid bias in variant calling.
- `view -b`: Outputs the sorted and duplicate-free data in BAM format.

**Indexing BAM files**:

```bash
samtools index output_directory/20_bam/parent.bam
samtools index output_directory/20_bam/bulk1.bam
samtools index output_directory/20_bam/bulk2.bam
```

For large genomes (e.g., wheat), attempting to create a standard `.bai` index file using `samtools index` without the `-c` option may result in an error due to file size limitations. In such cases, it is necessary to use the `-c` option, which generates a `.csi` index that supports large reference genomes:

```bash
samtools index -c output_directory/20_bam/parent.bam
samtools index -c output_directory/20_bam/bulk1.bam
samtools index -c output_directory/20_bam/bulk2.bam
```

This `.csi` index is suitable for handling large genomes that exceed the size limitations of `.bai`.

---

## Step 6: Variant Calling with mpileup

**Description**:  
Once the BAM files are indexed, the next step is to call variants using **bcftools mpileup** and **bcftools call**. The `AD`, `ADF`, and `ADR` fields are critical for QTL-seq, as they provide allele depth information that is essential for the analysis. This command identifies SNPs and other variants in the sequencing data.

For more information on **BCFtools**, refer to the manual [here](https://www.htslib.org/doc/bcftools.html).

### Usage:

```bash
bcftools mpileup -a AD,ADF,ADR -B -q 40 -Q 18 -C 50 -O u -f output_directory/10_ref/qtlseq_ref.fasta \
output_directory/20_bam/parent.bam output_directory/20_bam/bulk1.bam output_directory/20_bam/bulk2.bam | \
bcftools call -vm -f GQ,GP -O u | \
bcftools filter -i "INFO/MQ>=40" -O z -o output_directory/30_vcf/qtlseq.vcf.gz
```

### Explanation:

- `mpileup`: Generates per-base information for each position in the reference genome.
- `-a AD,ADF,ADR`: Includes allele depth information in the output. These fields are crucial for QTL-seq analysis.
- `-B`: Disables BAQ computation.
- `-q 40`: Filters reads with mapping quality less than 40.
- `-Q 18`: Filters bases with base quality less than 18.
- `-C 50`: Adjusts the mapping quality to account for the use of BWA during alignment.

### Important Note:
When generating the VCF file, the order in which the **parent**, **bulk1**, and **bulk2** BAM files are passed into the `bcftools mpileup` command is important. The **parent** should come first, followed by **bulk1** and **bulk2**. This order is critical for downstream analysis, especially when using **QTLplot**, as the software expects the **parent** data to be the first sample in the VCF file.

### Chromosome-specific processing:  
The `-r` option in `bcftools mpileup` allows for chromosome-specific processing, which can be used to parallelize the VCF generation for each chromosome individually. This can help speed up the variant calling process for large genomes.

#### Usage for Chromosome-specific processing:

```bash
bcftools mpileup -r test_chr -a AD,ADF,ADR -B -q 40 -Q 18 -C 50 -O u -f output_directory/10_ref/qtlseq_ref.fasta \
output_directory/20_bam/parent.bam output_directory/20_bam/bulk1.bam output_directory/20_bam/bulk2.bam | \
bcftools call -vm -f GQ,GP -O u | \
bcftools filter -i "INFO/MQ>=40" -O z -o output_directory/30_vcf/qtlseq.test_chr.vcf.gz
```

### Concatenating VCF Files:  
If the VCF files are generated separately for each chromosome, you can use `bcftools concat` to concatenate them into a single VCF file for easier analysis.

#### Usage for Concatenating VCF Files:

```bash
bcftools concat -O z -o output_directory/30_vcf/qtlseq_combined.vcf.gz output_directory/30_vcf/qtlseq.*.vcf.gz
```

This command will concatenate all chromosome-specific VCF files (`qtlseq.*.vcf.gz`) into a single compressed VCF file (`qtlseq_combined.vcf.gz`).

### Index the VCF file with Tabix:

For more information on **Tabix**, refer to the manual [here](https://www.htslib.org/doc/tabix.html).

```bash
tabix -f -p vcf output_directory/30_vcf/qtlseq.vcf.gz
```

### Note for Large Genomes (e.g., Wheat):

For large genomes like wheat, using the default `tabix` indexing without the `-C` option may result in an error due to file size limitations. In such cases, it is necessary to use the `-C` option, which generates a `.csi` index that supports large reference genomes:

```bash
tabix -C -f -p vcf output_directory/30_vcf/qtlseq.vcf.gz
```

This `.csi` index is suitable for handling large genomes that exceed the size limitations of standard `.tbi` indexes.

---

## Step 7: SNP Filtering, SNP Index Calculation, and Visualization with QTLplot

**Description**:  
QTLplot is used to filter SNPs, calculate SNP indices, and visualize the results. It helps identify significant SNPs and their impact on the genome, producing various files that assist in analyzing and visualizing the data.

**Usage**:

```bash
qtlplot -v output_directory/30_vcf/qtlseq.vcf.gz -o output_directory/40_plot -n1 20 -n2 20
```

**Required Options**:

- `-v`: Specifies the input VCF file generated by the variant calling step.
- `-o`: Specifies the output directory for the visualization results.
- `-n1`: Specifies the number of individuals in **bulk1**.
- `-n2`: Specifies the number of individuals in **bulk2**.

---

## Using SnpEff for Variant Annotation

**Optional: Using QTLplot with SnpEff**:  
QTLplot can be run in combination with **SnpEff** to annotate variants for their potential effects. This allows for a more detailed understanding of how SNPs may impact gene function. For more information on SnpEff, please refer to the [SnpEff Documentation](https://pcingola.github.io/SnpEff/snpeff/introduction/).

**Usage**:

```bash
qtlplot -v output_directory/30_vcf/qtlseq.vcf.gz -o output_directory/40_plot -n1 20 -n2 20 -e database
```

**Additional Option**:

- `-e database`: Specifies the SnpEff database to

 use for annotating variants. Ensure that the correct SnpEff database is installed and available before running this command.
